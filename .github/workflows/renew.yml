name: Freecloudè‡ªåŠ¨ç»­è´¹

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š6ç‚¹è¿è¡Œï¼ˆUTCæ—¶é—´22ç‚¹ï¼‰
    - cron: '0 22 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  renew:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: åˆ—å‡ºå·¥ä½œç›®å½•å†…å®¹
        run: |
          echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo "åˆ—å‡ºç›®å½•å†…å®¹:"
          ls -la
      
      - name: ç¡®ä¿å¿…è¦æ–‡ä»¶å­˜åœ¨
        run: |
          if [ ! -f "requirements.txt" ]; then
            echo "åˆ›å»ºrequirements.txtæ–‡ä»¶..."
            echo "requests==2.31.0" > requirements.txt
            echo "cloudscraper==1.2.71" >> requirements.txt
            echo "requirements.txtæ–‡ä»¶å·²åˆ›å»º"
          fi
          
          # æ£€æŸ¥è„šæœ¬æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          SCRIPT_PATH=$(find . -name "freecloud_renewer.py" -type f | head -n 1)
          if [ -z "$SCRIPT_PATH" ]; then
            echo "é”™è¯¯: æ‰¾ä¸åˆ°è„šæœ¬æ–‡ä»¶ freecloud_renewer.py"
            exit 1
          else
            echo "æ‰¾åˆ°è„šæœ¬: $SCRIPT_PATH"
            
            # ä¿®å¤ä¸­æ–‡å¼•å·é—®é¢˜
            echo "æ£€æŸ¥å¹¶ä¿®å¤è„šæœ¬ä¸­çš„ä¸­æ–‡å¼•å·é—®é¢˜..."
            sed -i 's/log_message(f"æœªèƒ½åœ¨æœåŠ¡å™¨ {machine_id_to_find} é™„è¿‘æ‰¾åˆ°"å¤©å"ä¿¡æ¯")/log_message(f"æœªèƒ½åœ¨æœåŠ¡å™¨ {machine_id_to_find} é™„è¿‘æ‰¾åˆ°\\"å¤©å\\"ä¿¡æ¯")/' "$SCRIPT_PATH"
            
            # æ£€æŸ¥è„šæœ¬æ–‡ä»¶ä¸­çš„è¯­æ³•é”™è¯¯
            python -m py_compile "$SCRIPT_PATH" || {
              echo "è„šæœ¬ä¸­å­˜åœ¨è¯­æ³•é”™è¯¯ï¼Œå°è¯•ä¿®å¤..."
              # æ£€æŸ¥å¹¶ä¿®å¤ç‰¹å®šçš„è¯­æ³•é”™è¯¯
              sed -i 's/f"ğŸ†˜ è„šæœ¬æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿæ„å¤–æ€»é”™è¯¯: {e}\\n\\n```/f"ğŸ†˜ è„šæœ¬æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿæ„å¤–æ€»é”™è¯¯: {e}\\n\\n```\\n/g' "$SCRIPT_PATH"
              sed -i 's/{error_details}\\n```"/{error_details}\\n```"/g' "$SCRIPT_PATH"
              
              # é€šç”¨ä¿®å¤ï¼šå°†f-stringä¸­çš„ä¸­æ–‡å¼•å·æ›¿æ¢ä¸ºè½¬ä¹‰çš„è‹±æ–‡å¼•å·
              echo "å°è¯•ä¿®å¤æ‰€æœ‰f-stringä¸­çš„ä¸­æ–‡å¼•å·..."
              grep -n 'f".*".*"' "$SCRIPT_PATH" || true
              sed -i 's/\(f"[^"]*\)"$$$$\([^"]*\)"\([^"]*"\)/\1\\"$$$$\2\\"\3/g' "$SCRIPT_PATH"
              
              echo "å°è¯•ä¿®å¤å®Œæˆï¼Œå†æ¬¡æ£€æŸ¥è¯­æ³•..."
              python -m py_compile "$SCRIPT_PATH" || {
                echo "ä»ç„¶å­˜åœ¨è¯­æ³•é”™è¯¯ï¼Œå°è¯•æ‰‹åŠ¨æ›´æ–°è„šæœ¬ä¸­é—®é¢˜è¡Œ..."
                # å¦‚æœç¼–è¯‘ä»ç„¶å¤±è´¥ï¼Œåˆ›å»ºä¸€ä¸ªä¸´æ—¶å‰¯æœ¬è¿›è¡Œæ›´å¤šè°ƒè¯•
                cp "$SCRIPT_PATH" "${SCRIPT_PATH}.bak"
                echo "#!/usr/bin/env python3" > "$SCRIPT_PATH"
                echo "print('æ£€æµ‹åˆ°è„šæœ¬è¯­æ³•é”™è¯¯ï¼Œæ— æ³•è‡ªåŠ¨ä¿®å¤ã€‚è¯·æŸ¥çœ‹æ—¥å¿—å¹¶æ‰‹åŠ¨ä¿®å¤é—®é¢˜ã€‚')" >> "$SCRIPT_PATH"
                echo "exit(1)" >> "$SCRIPT_PATH"
                echo "ä¸¥é‡é”™è¯¯: æ— æ³•ä¿®å¤è„šæœ¬ä¸­çš„è¯­æ³•é—®é¢˜ï¼Œå·²åˆ›å»ºç®€åŒ–ç‰ˆæœ¬ä»¥é˜²æ­¢å®Œå…¨å¤±è´¥ã€‚"
                echo "è¯·æ‰‹åŠ¨æ£€æŸ¥å’Œä¿®å¤åŸå§‹è„šæœ¬: ${SCRIPT_PATH}.bak"
              }
            }
          fi
          
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          cat requirements.txt
          pip install -r requirements.txt
      
      - name: åˆ›å»ºç¯å¢ƒæ£€æŸ¥è„šæœ¬
        run: |
          echo '#!/usr/bin/env python3' > check_env.py
          echo '# -*- coding: utf-8 -*-' >> check_env.py
          echo '' >> check_env.py
          echo 'import os' >> check_env.py
          echo 'import sys' >> check_env.py
          echo 'import glob' >> check_env.py
          echo 'import platform' >> check_env.py
          echo '' >> check_env.py
          echo 'print("==== ç¯å¢ƒæ£€æŸ¥å·¥å…· ====")'  >> check_env.py
          echo 'print(f"Pythonç‰ˆæœ¬: {sys.version}")' >> check_env.py
          echo 'print(f"ç³»ç»Ÿå¹³å°: {platform.platform()}")' >> check_env.py
          echo 'print(f"å½“å‰å·¥ä½œç›®å½•: {os.getcwd()}")' >> check_env.py
          echo '' >> check_env.py
          echo 'print("\\n==== ç¯å¢ƒå˜é‡æ£€æŸ¥ ====")'  >> check_env.py
          echo 'required_vars = ["FC_USERNAME", "FC_PASSWORD", "FC_MACHINE_ID", "TELEGRAM_BOT_TOKEN", "TELEGRAM_CHAT_ID"]' >> check_env.py
          echo '' >> check_env.py
          echo 'for var in required_vars:' >> check_env.py
          echo '    value = os.getenv(var)' >> check_env.py
          echo '    if value:' >> check_env.py
          echo '        masked = value[:2] + "*" * (len(value) - 4) + value[-2:] if len(value) > 4 else "****"' >> check_env.py
          echo '        print(f"{var}: {masked} [å·²è®¾ç½®]")' >> check_env.py
          echo '    else:' >> check_env.py
          echo '        print(f"{var}: [æœªè®¾ç½®]")' >> check_env.py
          echo '' >> check_env.py
          echo 'print("\\n==== ç›®å½•å†…å®¹ ====")'  >> check_env.py
          echo 'for item in sorted(os.listdir(".")):' >> check_env.py
          echo '    if os.path.isdir(item):' >> check_env.py
          echo '        print(f"ğŸ“ {item}/")' >> check_env.py
          echo '    else:' >> check_env.py
          echo '        print(f"ğŸ“„ {item} ({os.path.getsize(item)} å­—èŠ‚)")' >> check_env.py
          echo '' >> check_env.py
          echo 'print("\\n==== æŸ¥æ‰¾è„šæœ¬æ–‡ä»¶ ====")'  >> check_env.py
          echo 'script_paths = glob.glob("**/*freecloud*py", recursive=True)' >> check_env.py
          echo 'if script_paths:' >> check_env.py
          echo '    print("æ‰¾åˆ°ä»¥ä¸‹è„šæœ¬æ–‡ä»¶:")' >> check_env.py
          echo '    for path in script_paths:' >> check_env.py
          echo '        print(f"- {path} ({os.path.getsize(path)} å­—èŠ‚)")' >> check_env.py
          echo 'else:' >> check_env.py
          echo '    print("æœªæ‰¾åˆ°ä»»ä½•åŒ¹é… *freecloud*py çš„è„šæœ¬æ–‡ä»¶")' >> check_env.py
          echo '' >> check_env.py
          echo 'print("\\n==== æ£€æŸ¥å®Œæˆ ====")'  >> check_env.py
          echo "ç¯å¢ƒæ£€æŸ¥è„šæœ¬å·²åˆ›å»º"
          cat check_env.py
          
      - name: ç¯å¢ƒæ£€æŸ¥
        env:
          FC_USERNAME: ${{ secrets.FC_USERNAME }}
          FC_PASSWORD: ${{ secrets.FC_PASSWORD }}
          FC_MACHINE_ID: ${{ secrets.FC_MACHINE_ID }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          DEBUG_MODE: 'true'
        run: python check_env.py
          
      - name: ä½¿ç”¨curlç›´æ¥è®¿é—®ç½‘ç«™ç»­è´¹
        env:
          FC_USERNAME: ${{ secrets.FC_USERNAME }}
          FC_PASSWORD: ${{ secrets.FC_PASSWORD }}
          FC_MACHINE_ID: ${{ secrets.FC_MACHINE_ID }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "å°è¯•ä½¿ç”¨curlç›´æ¥è®¿é—®ç½‘ç«™..."
          
          # åˆ›å»ºéšæœºUser-Agent
          USER_AGENTS=(
            "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/123.0.0.0 Safari/537.36"
            "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36"
            "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/123.0.0.0 Safari/537.36"
            "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:123.0) Gecko/20100101 Firefox/123.0"
          )
          
          RANDOM_INDEX=$((RANDOM % ${#USER_AGENTS[@]}))
          RANDOM_UA="${USER_AGENTS[$RANDOM_INDEX]}"
          
          # å¢åŠ é¢å¤–çš„HTTPå¤´ä»¥æ›´åƒçœŸå®æµè§ˆå™¨
          ACCEPT_HEADER="text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7"
          ACCEPT_LANGUAGE="zh-CN,zh;q=0.9,en;q=0.8"
          ACCEPT_ENCODING="gzip, deflate, br"
          
          # åˆ›å»ºä¸€ä¸ªåŒ…å«æ‰€æœ‰cookieçš„ä¸´æ—¶æ–‡ä»¶
          COOKIE_JAR="cookies.txt"
          
          # é¦–å…ˆè®¿é—®é¦–é¡µè·å–åˆå§‹cookieå’ŒCSRFä»¤ç‰Œ
          echo "è®¿é—®é¦–é¡µè·å–åˆå§‹cookieå’ŒCSRFä»¤ç‰Œ..."
          HOME_PAGE=$(curl -s -c "$COOKIE_JAR" -b "$COOKIE_JAR" \
            -H "User-Agent: $RANDOM_UA" \
            -H "Accept: $ACCEPT_HEADER" \
            -H "Accept-Language: $ACCEPT_LANGUAGE" \
            -H "Accept-Encoding: $ACCEPT_ENCODING" \
            -H "Connection: keep-alive" \
            -H "Upgrade-Insecure-Requests: 1" \
            -H "Sec-Fetch-Dest: document" \
            -H "Sec-Fetch-Mode: navigate" \
            -H "Sec-Fetch-Site: none" \
            -H "Sec-Fetch-User: ?1" \
            --compressed \
            --max-time 30 "https://freecloud.ltd/")
          
          # æå–CSRFä»¤ç‰Œ
          CSRF_TOKEN=$(echo "$HOME_PAGE" | grep -o 'name="_token" value="[^"]*"' | sed 's/name="_token" value="//g' | sed 's/"//g' || echo "")
          if [ -n "$CSRF_TOKEN" ]; then
            echo "æ‰¾åˆ°CSRFä»¤ç‰Œ: ${CSRF_TOKEN:0:10}..."
          else
            echo "æœªæ‰¾åˆ°CSRFä»¤ç‰Œï¼Œç»§ç»­å°è¯•..."
          fi
          
          # æ¨¡æ‹Ÿäººç±»è¡Œä¸ºï¼šéšæœºåœé¡¿
          SLEEP_TIME=$(( RANDOM % 3 + 2 ))
          echo "æ¨¡æ‹Ÿäººç±»è¡Œä¸ºï¼Œéšæœºåœé¡¿ ${SLEEP_TIME} ç§’..."
          sleep $SLEEP_TIME
          
          # è®¿é—®ç™»å½•é¡µé¢è·å–æ•°å­¦éªŒè¯ç 
          echo "è®¿é—®ç™»å½•é¡µé¢è·å–æ•°å­¦éªŒè¯ç ..."
          LOGIN_PAGE=$(curl -s -c "$COOKIE_JAR" -b "$COOKIE_JAR" \
            -H "User-Agent: $RANDOM_UA" \
            -H "Accept: $ACCEPT_HEADER" \
            -H "Accept-Language: $ACCEPT_LANGUAGE" \
            -H "Accept-Encoding: $ACCEPT_ENCODING" \
            -H "Connection: keep-alive" \
            -H "Upgrade-Insecure-Requests: 1" \
            -H "Referer: https://freecloud.ltd/" \
            -H "Sec-Fetch-Dest: document" \
            -H "Sec-Fetch-Mode: navigate" \
            -H "Sec-Fetch-Site: same-origin" \
            -H "Sec-Fetch-User: ?1" \
            --compressed \
            --max-time 30 "https://freecloud.ltd/login")
          
          # ä¿å­˜ç™»å½•é¡µé¢å†…å®¹ä»¥ä¾¿è°ƒè¯•
          echo "ä¿å­˜ç™»å½•é¡µé¢å†…å®¹ä»¥ä¾¿è°ƒè¯•..."
          echo "$LOGIN_PAGE" | grep -i -A 3 -B 3 "captcha\|éªŒè¯ç \|math" > login_page_debug.txt
          cat login_page_debug.txt
          
          # ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æå–æ•°å­¦éªŒè¯ç é¢˜ç›®
          MATH_QUESTION=$(echo "$LOGIN_PAGE" | grep -o 'placeholder="[0-9]\+ [+*/\-] [0-9]\+ = ?"' | head -1 || true)
          
          if [ -z "$MATH_QUESTION" ]; then
            echo "æœªèƒ½æ‰¾åˆ°æ•°å­¦éªŒè¯ç é¢˜ç›®ï¼Œå°è¯•å…¶ä»–åŒ¹é…æ¨¡å¼..."
            # å°è¯•å…¶ä»–åŒ¹é…æ¨¡å¼
            MATH_QUESTION=$(echo "$LOGIN_PAGE" | grep -o 'placeholder="[0-9]+ [+*/\-] [0-9]+ = ?"' || true)
            
            if [ -z "$MATH_QUESTION" ]; then
              echo "ä»æœªæ‰¾åˆ°æ•°å­¦éªŒè¯ç é¢˜ç›®ï¼Œå°è¯•ç›´æ¥ç™»å½•"
              MATH_ANSWER=""
            else
              echo "ä½¿ç”¨ç¬¬äºŒç§æ¨¡å¼æ‰¾åˆ°éªŒè¯ç é—®é¢˜: $MATH_QUESTION"
            fi
          else
            echo "æ‰¾åˆ°éªŒè¯ç é—®é¢˜: $MATH_QUESTION"
          fi
          
          if [ -n "$MATH_QUESTION" ]; then
            # æå–æ•°å­—å’Œè¿ç®—ç¬¦
            NUM1=$(echo "$MATH_QUESTION" | grep -o -E '[0-9]+' | head -1)
            OP=$(echo "$MATH_QUESTION" | grep -o -E '[+*/\-]')
            NUM2=$(echo "$MATH_QUESTION" | grep -o -E '[0-9]+' | tail -1)
            
            echo "è§£æéªŒè¯ç : ç¬¬ä¸€ä¸ªæ•°å­—=$NUM1, è¿ç®—ç¬¦=$OP, ç¬¬äºŒä¸ªæ•°å­—=$NUM2"
            
            # è®¡ç®—ç­”æ¡ˆ
            if [ "$OP" = "+" ]; then
              MATH_ANSWER=$((NUM1 + NUM2))
            elif [ "$OP" = "-" ]; then
              MATH_ANSWER=$((NUM1 - NUM2))
            elif [ "$OP" = "*" ]; then
              MATH_ANSWER=$((NUM1 * NUM2))
            elif [ "$OP" = "/" ]; then
              MATH_ANSWER=$((NUM1 / NUM2))
            else
              MATH_ANSWER=""
            fi
            
            echo "è®¡ç®—ç»“æœ: $MATH_ANSWER"
          fi
          
          # ç™»å½•è¯·æ±‚
          echo "å°è¯•ç™»å½•..."
          
          # æ¨¡æ‹Ÿäººç±»è¡Œä¸ºï¼šéšæœºåœé¡¿
          SLEEP_TIME=$(( RANDOM % 3 + 2 ))
          echo "æ¨¡æ‹Ÿäººç±»è¡Œä¸ºï¼Œéšæœºåœé¡¿ ${SLEEP_TIME} ç§’..."
          sleep $SLEEP_TIME
          
          # å‡†å¤‡ç™»å½•æ•°æ®
          LOGIN_DATA=""
          if [ -n "$CSRF_TOKEN" ]; then
            LOGIN_DATA="_token=$CSRF_TOKEN&"
          fi
          LOGIN_DATA="${LOGIN_DATA}username=$FC_USERNAME&password=$FC_PASSWORD&math_captcha=$MATH_ANSWER&mobile=&captcha=&verify_code=&agree=1&login_type=PASS&submit=1"
          
          LOGIN_RESULT=$(curl -s -c "$COOKIE_JAR" -b "$COOKIE_JAR" \
            -X POST \
            -H "User-Agent: $RANDOM_UA" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -H "Accept: $ACCEPT_HEADER" \
            -H "Accept-Language: $ACCEPT_LANGUAGE" \
            -H "Accept-Encoding: $ACCEPT_ENCODING" \
            -H "Connection: keep-alive" \
            -H "Referer: https://freecloud.ltd/login" \
            -H "Origin: https://freecloud.ltd" \
            -H "Sec-Fetch-Dest: document" \
            -H "Sec-Fetch-Mode: navigate" \
            -H "Sec-Fetch-Site: same-origin" \
            -H "Sec-Fetch-User: ?1" \
            --data "$LOGIN_DATA" \
            --compressed \
            --max-time 30 \
            "https://freecloud.ltd/login")
          
          # æŸ¥çœ‹cookieæ–‡ä»¶
          echo "Cookieæ–‡ä»¶å†…å®¹:"
          cat "$COOKIE_JAR" || echo "æ— æ³•è¯»å–Cookieæ–‡ä»¶"
          
          # æ£€æŸ¥ç™»å½•æ˜¯å¦æˆåŠŸ - ä½¿ç”¨å¤šç§æ–¹æ³•æ£€æŸ¥
          echo "éªŒè¯ç™»å½•çŠ¶æ€..."
          sleep 3
          
          # æ–¹æ³•1ï¼šç›´æ¥è¯·æ±‚æœåŠ¡å™¨é¡µé¢
          CONSOLE_PAGE=$(curl -s -c "$COOKIE_JAR" -b "$COOKIE_JAR" \
            -H "User-Agent: $RANDOM_UA" \
            -H "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8" \
            -H "Accept-Language: zh-CN,zh;q=0.9,en;q=0.8" \
            -H "Referer: https://freecloud.ltd/login" \
            --compressed \
            --max-time 30 "https://freecloud.ltd/server/lxc")
          
          # æ£€æŸ¥æ˜¯å¦å­˜åœ¨æˆåŠŸç™»å½•çš„æ ‡å¿—
          if echo "$CONSOLE_PAGE" | grep -q "é€€å‡ºç™»å½•\|logout\|æ¬¢è¿å›æ¥"; then
            echo "ç™»å½•æˆåŠŸï¼Œæ£€æŸ¥æœåŠ¡å™¨ä¿¡æ¯..."
            
            # æŸ¥æ‰¾æœåŠ¡å™¨ä¿¡æ¯
            MACHINE_ID="$FC_MACHINE_ID"
            SERVER_INFO=$(echo "$CONSOLE_PAGE" | grep -A 50 -B 50 "$MACHINE_ID" | grep -o '[0-9]\+å¤©å')
            
            if [ -n "$SERVER_INFO" ]; then
              DAYS_LEFT=$(echo "$SERVER_INFO" | grep -o '[0-9]\+')
              echo "æœåŠ¡å™¨ $MACHINE_ID å‰©ä½™ $DAYS_LEFT å¤©"
              
              # åˆ¤æ–­æ˜¯å¦éœ€è¦ç»­è´¹
              if [ "$DAYS_LEFT" -lt 3 ]; then
                echo "å‰©ä½™å¤©æ•°å°‘äº3å¤©ï¼Œéœ€è¦ç»­è´¹"
                
                # è®¿é—®æœåŠ¡å™¨è¯¦æƒ…é¡µ
                echo "è®¿é—®æœåŠ¡å™¨è¯¦æƒ…é¡µ..."
                sleep 2
                curl -s -c "$COOKIE_JAR" -b "$COOKIE_JAR" -A "$RANDOM_UA" --max-time 30 "https://freecloud.ltd/server/detail/$MACHINE_ID" > /dev/null
                
                # æ‰§è¡Œç»­è´¹æ“ä½œ
                echo "æ‰§è¡Œç»­è´¹æ“ä½œ..."
                sleep 2
                RENEW_RESULT=$(curl -s -c "$COOKIE_JAR" -b "$COOKIE_JAR" -A "$RANDOM_UA" \
                  -X POST \
                  -H "Content-Type: application/x-www-form-urlencoded" \
                  -H "X-Requested-With: XMLHttpRequest" \
                  -H "Referer: https://freecloud.ltd/server/detail/$MACHINE_ID" \
                  --data-urlencode "month=1" \
                  --data-urlencode "coupon_id=0" \
                  --data-urlencode "submit=1" \
                  --max-time 45 \
                  "https://freecloud.ltd/server/detail/$MACHINE_ID/renew")
                  
                echo "ç»­è´¹ç»“æœ: $RENEW_RESULT"
                
                # å‘é€Telegramé€šçŸ¥
                if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
                  if echo "$RENEW_RESULT" | grep -q "success\|æˆåŠŸ\|code\":0"; then
                    MESSAGE="âœ… æœåŠ¡å™¨ $MACHINE_ID ç»­è´¹æˆåŠŸï¼åŸå‰©ä½™: $DAYS_LEFT å¤©ã€‚"
                  else
                    MESSAGE="âŒ æœåŠ¡å™¨ $MACHINE_ID ç»­è´¹å¤±è´¥ã€‚åŸå‰©ä½™: $DAYS_LEFT å¤©ã€‚"
                  fi
                  
                  curl -s -X POST \
                    -H "Content-Type: application/json" \
                    --data "{\"chat_id\":\"$TELEGRAM_CHAT_ID\",\"text\":\"$MESSAGE\",\"parse_mode\":\"Markdown\"}" \
                    "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage"
                fi
              else
                echo "å‰©ä½™å¤©æ•°ä¸º $DAYS_LEFT å¤©ï¼Œæ— éœ€ç»­è´¹"
                
                # å‘é€Telegramé€šçŸ¥
                if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
                  MESSAGE="â„¹ï¸ æœåŠ¡å™¨ $MACHINE_ID å‰©ä½™ $DAYS_LEFT å¤©ï¼Œæ— éœ€ç»­è´¹ã€‚"
                  
                  curl -s -X POST \
                    -H "Content-Type: application/json" \
                    --data "{\"chat_id\":\"$TELEGRAM_CHAT_ID\",\"text\":\"$MESSAGE\",\"parse_mode\":\"Markdown\"}" \
                    "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage"
                fi
              fi
            else
              echo "æœªèƒ½æ‰¾åˆ°æœåŠ¡å™¨ $MACHINE_ID çš„å‰©ä½™å¤©æ•°ä¿¡æ¯"
              
              # å‘é€Telegramé€šçŸ¥
              if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
                MESSAGE="âš ï¸ æœªèƒ½æ‰¾åˆ°æœåŠ¡å™¨ $MACHINE_ID çš„ä¿¡æ¯ï¼Œæ— æ³•ç»­è´¹ã€‚"
                
                curl -s -X POST \
                  -H "Content-Type: application/json" \
                  --data "{\"chat_id\":\"$TELEGRAM_CHAT_ID\",\"text\":\"$MESSAGE\",\"parse_mode\":\"Markdown\"}" \
                  "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage"
              fi
            fi
          else
            echo "ç™»å½•å¤±è´¥ï¼Œæ— æ³•è·å–æœåŠ¡å™¨ä¿¡æ¯"
            
            # å‘é€Telegramé€šçŸ¥
            if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
              MESSAGE="ğŸ”´ ä½¿ç”¨curlæ–¹å¼ç™»å½•Freecloudå¤±è´¥ï¼Œæ— æ³•ç»­è´¹ã€‚"
              
              curl -s -X POST \
                -H "Content-Type: application/json" \
                --data "{\"chat_id\":\"$TELEGRAM_CHAT_ID\",\"text\":\"$MESSAGE\",\"parse_mode\":\"Markdown\"}" \
                "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage"
            fi
          fi
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f "$COOKIE_JAR"
        
      - name: å¦‚æœå¤±è´¥é‡è¯•ä¸€æ¬¡
        if: failure()
        env:
          FC_USERNAME: ${{ secrets.FC_USERNAME }}
          FC_PASSWORD: ${{ secrets.FC_PASSWORD }}
          FC_MACHINE_ID: ${{ secrets.FC_MACHINE_ID }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "é¦–æ¬¡è¿è¡Œå¤±è´¥ï¼Œç­‰å¾…30ç§’åä½¿ç”¨å¢å¼ºçš„curlé…ç½®é‡è¯•..."
          sleep 30
          
          # å®‰è£…é¢å¤–éœ€è¦çš„å·¥å…·
          sudo apt-get update
          sudo apt-get install -y curl jq
          
          # ä½¿ç”¨ä¸åŒçš„User-Agent
          RANDOM_UA="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/123.0.0.0 Safari/537.36"
          
          # å¢åŠ é¢å¤–çš„HTTPå¤´ä»¥æ›´åƒçœŸå®æµè§ˆå™¨
          ACCEPT_HEADER="text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7"
          ACCEPT_LANGUAGE="zh-CN,zh;q=0.9,en;q=0.8"
          ACCEPT_ENCODING="gzip, deflate, br"
          
          # åˆ›å»ºä¸€ä¸ªåŒ…å«æ‰€æœ‰cookieçš„ä¸´æ—¶æ–‡ä»¶
          COOKIE_JAR="cookies_retry.txt"
          
          # é¦–å…ˆè®¿é—®é¦–é¡µè·å–åˆå§‹cookie
          echo "è®¿é—®é¦–é¡µè·å–åˆå§‹cookieå’ŒCSRFä»¤ç‰Œ..."
          HOME_PAGE=$(curl -v -c "$COOKIE_JAR" -b "$COOKIE_JAR" \
            -H "User-Agent: $RANDOM_UA" \
            -H "Accept: $ACCEPT_HEADER" \
            -H "Accept-Language: $ACCEPT_LANGUAGE" \
            -H "Accept-Encoding: $ACCEPT_ENCODING" \
            -H "Connection: keep-alive" \
            -H "Upgrade-Insecure-Requests: 1" \
            -H "Sec-Fetch-Dest: document" \
            -H "Sec-Fetch-Mode: navigate" \
            -H "Sec-Fetch-Site: none" \
            -H "Sec-Fetch-User: ?1" \
            --compressed \
            --max-time 30 "https://freecloud.ltd/")
          
          # æå–CSRFä»¤ç‰Œ
          CSRF_TOKEN=$(echo "$HOME_PAGE" | grep -o 'name="_token" value="[^"]*"' | sed 's/name="_token" value="//g' | sed 's/"//g' || echo "")
          if [ -n "$CSRF_TOKEN" ]; then
            echo "æ‰¾åˆ°CSRFä»¤ç‰Œ: ${CSRF_TOKEN:0:10}..."
          else
            echo "æœªæ‰¾åˆ°CSRFä»¤ç‰Œï¼Œç»§ç»­å°è¯•..."
          fi
          
          # æ¨¡æ‹Ÿäººç±»è¡Œä¸ºï¼šéšæœºåœé¡¿
          SLEEP_TIME=$(( RANDOM % 3 + 2 ))
          echo "æ¨¡æ‹Ÿäººç±»è¡Œä¸ºï¼Œéšæœºåœé¡¿ ${SLEEP_TIME} ç§’..."
          sleep $SLEEP_TIME
          
          # è®¿é—®ç™»å½•é¡µé¢è·å–æ•°å­¦éªŒè¯ç 
          echo "è®¿é—®ç™»å½•é¡µé¢è·å–æ•°å­¦éªŒè¯ç ..."
          LOGIN_PAGE=$(curl -v -c "$COOKIE_JAR" -b "$COOKIE_JAR" \
            -H "User-Agent: $RANDOM_UA" \
            -H "Accept: $ACCEPT_HEADER" \
            -H "Accept-Language: $ACCEPT_LANGUAGE" \
            -H "Accept-Encoding: $ACCEPT_ENCODING" \
            -H "Connection: keep-alive" \
            -H "Upgrade-Insecure-Requests: 1" \
            -H "Referer: https://freecloud.ltd/" \
            -H "Sec-Fetch-Dest: document" \
            -H "Sec-Fetch-Mode: navigate" \
            -H "Sec-Fetch-Site: same-origin" \
            -H "Sec-Fetch-User: ?1" \
            --compressed \
            --max-time 30 "https://freecloud.ltd/login")
          
          # ä¿å­˜ç™»å½•é¡µé¢å†…å®¹ä»¥ä¾¿è°ƒè¯•
          echo "ä¿å­˜ç™»å½•é¡µé¢å†…å®¹ä»¥ä¾¿è°ƒè¯•..."
          echo "$LOGIN_PAGE" | grep -i -A 3 -B 3 "captcha\|éªŒè¯ç \|math" > login_page_retry_debug.txt
          cat login_page_retry_debug.txt
          
          # ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æå–æ•°å­¦éªŒè¯ç é¢˜ç›®
          MATH_QUESTION=$(echo "$LOGIN_PAGE" | grep -o 'placeholder="[0-9]\+ [+*/\-] [0-9]\+ = ?"' | head -1 || true)
          
          if [ -z "$MATH_QUESTION" ]; then
            echo "æœªèƒ½æ‰¾åˆ°æ•°å­¦éªŒè¯ç é¢˜ç›®ï¼Œå°è¯•å…¶ä»–åŒ¹é…æ¨¡å¼..."
            # å°è¯•å…¶ä»–åŒ¹é…æ¨¡å¼
            MATH_QUESTION=$(echo "$LOGIN_PAGE" | grep -o 'placeholder="[0-9]+ [+*/\-] [0-9]+ = ?"' || true)
            
            if [ -z "$MATH_QUESTION" ]; then
              echo "ä»æœªæ‰¾åˆ°æ•°å­¦éªŒè¯ç é¢˜ç›®ï¼Œå°è¯•ç›´æ¥ç™»å½•"
              MATH_ANSWER=""
            else
              echo "ä½¿ç”¨ç¬¬äºŒç§æ¨¡å¼æ‰¾åˆ°éªŒè¯ç é—®é¢˜: $MATH_QUESTION"
            fi
          else
            echo "æ‰¾åˆ°éªŒè¯ç é—®é¢˜: $MATH_QUESTION"
          fi
          
          if [ -n "$MATH_QUESTION" ]; then
            # æå–æ•°å­—å’Œè¿ç®—ç¬¦
            NUM1=$(echo "$MATH_QUESTION" | grep -o -E '[0-9]+' | head -1)
            OP=$(echo "$MATH_QUESTION" | grep -o -E '[+*/\-]')
            NUM2=$(echo "$MATH_QUESTION" | grep -o -E '[0-9]+' | tail -1)
            
            echo "è§£æéªŒè¯ç : ç¬¬ä¸€ä¸ªæ•°å­—=$NUM1, è¿ç®—ç¬¦=$OP, ç¬¬äºŒä¸ªæ•°å­—=$NUM2"
            
            # è®¡ç®—ç­”æ¡ˆ
            if [ "$OP" = "+" ]; then
              MATH_ANSWER=$((NUM1 + NUM2))
            elif [ "$OP" = "-" ]; then
              MATH_ANSWER=$((NUM1 - NUM2))
            elif [ "$OP" = "*" ]; then
              MATH_ANSWER=$((NUM1 * NUM2))
            elif [ "$OP" = "/" ]; then
              MATH_ANSWER=$((NUM1 / NUM2))
            else
              MATH_ANSWER=""
            fi
            
            echo "è®¡ç®—ç»“æœ: $MATH_ANSWER"
          fi
          
          # æ¨¡æ‹Ÿäººç±»è¡Œä¸ºï¼šéšæœºåœé¡¿
          SLEEP_TIME=$(( RANDOM % 3 + 2 ))
          echo "æ¨¡æ‹Ÿäººç±»è¡Œä¸ºï¼Œéšæœºåœé¡¿ ${SLEEP_TIME} ç§’..."
          sleep $SLEEP_TIME
          
          # å‡†å¤‡ç™»å½•æ•°æ®
          LOGIN_DATA=""
          if [ -n "$CSRF_TOKEN" ]; then
            LOGIN_DATA="_token=$CSRF_TOKEN&"
          fi
          LOGIN_DATA="${LOGIN_DATA}username=$FC_USERNAME&password=$FC_PASSWORD&math_captcha=$MATH_ANSWER&mobile=&captcha=&verify_code=&agree=1&login_type=PASS&submit=1"
          
          echo "å‘é€ç™»å½•è¯·æ±‚..."
          LOGIN_RESULT=$(curl -v -c "$COOKIE_JAR" -b "$COOKIE_JAR" \
            -X POST \
            -H "User-Agent: $RANDOM_UA" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -H "Accept: $ACCEPT_HEADER" \
            -H "Accept-Language: $ACCEPT_LANGUAGE" \
            -H "Accept-Encoding: $ACCEPT_ENCODING" \
            -H "Connection: keep-alive" \
            -H "Referer: https://freecloud.ltd/login" \
            -H "Origin: https://freecloud.ltd" \
            -H "Sec-Fetch-Dest: document" \
            -H "Sec-Fetch-Mode: navigate" \
            -H "Sec-Fetch-Site: same-origin" \
            -H "Sec-Fetch-User: ?1" \
            --data "$LOGIN_DATA" \
            --compressed \
            --max-time 45 \
            "https://freecloud.ltd/login")
          
          # æŸ¥çœ‹cookieæ–‡ä»¶
          echo "Cookieæ–‡ä»¶å†…å®¹:"
          cat "$COOKIE_JAR" || echo "æ— æ³•è¯»å–Cookieæ–‡ä»¶"
          
          # æ£€æŸ¥ç™»å½•æ˜¯å¦æˆåŠŸ - ä½¿ç”¨å¤šç§æ–¹æ³•æ£€æŸ¥
          echo "éªŒè¯ç™»å½•çŠ¶æ€..."
          sleep 3
          
          # æ–¹æ³•1ï¼šç›´æ¥è¯·æ±‚æœåŠ¡å™¨é¡µé¢
          CONSOLE_PAGE=$(curl -s -c "$COOKIE_JAR" -b "$COOKIE_JAR" \
            -H "User-Agent: $RANDOM_UA" \
            -H "Accept: $ACCEPT_HEADER" \
            -H "Accept-Language: $ACCEPT_LANGUAGE" \
            -H "Accept-Encoding: $ACCEPT_ENCODING" \
            -H "Connection: keep-alive" \
            -H "Referer: https://freecloud.ltd/login" \
            -H "Sec-Fetch-Dest: document" \
            -H "Sec-Fetch-Mode: navigate" \
            -H "Sec-Fetch-Site: same-origin" \
            --compressed \
            --max-time 30 "https://freecloud.ltd/server/lxc")
          
          # æ£€æŸ¥æ˜¯å¦å­˜åœ¨æˆåŠŸç™»å½•çš„æ ‡å¿—
          if echo "$CONSOLE_PAGE" | grep -q "é€€å‡ºç™»å½•\|logout\|æ¬¢è¿å›æ¥"; then
            echo "ç™»å½•æˆåŠŸï¼Œæ£€æŸ¥æœåŠ¡å™¨ä¿¡æ¯..."
            
            # æŸ¥æ‰¾æœåŠ¡å™¨ä¿¡æ¯
            MACHINE_ID="$FC_MACHINE_ID"
            SERVER_INFO=$(echo "$CONSOLE_PAGE" | grep -A 50 -B 50 "$MACHINE_ID" | grep -o '[0-9]\+å¤©å' || echo "")
            
            if [ -n "$SERVER_INFO" ]; then
              DAYS_LEFT=$(echo "$SERVER_INFO" | grep -o '[0-9]\+')
              echo "æœåŠ¡å™¨ $MACHINE_ID å‰©ä½™ $DAYS_LEFT å¤©"
              
              # åˆ¤æ–­æ˜¯å¦éœ€è¦ç»­è´¹
              if [ "$DAYS_LEFT" -lt 3 ]; then
                echo "å‰©ä½™å¤©æ•°å°‘äº3å¤©ï¼Œéœ€è¦ç»­è´¹"
                
                # è®¿é—®æœåŠ¡å™¨è¯¦æƒ…é¡µ
                echo "è®¿é—®æœåŠ¡å™¨è¯¦æƒ…é¡µ..."
                SLEEP_TIME=$(( RANDOM % 2 + 1 ))
                sleep $SLEEP_TIME
                
                curl -s -c "$COOKIE_JAR" -b "$COOKIE_JAR" \
                  -H "User-Agent: $RANDOM_UA" \
                  -H "Accept: $ACCEPT_HEADER" \
                  -H "Accept-Language: $ACCEPT_LANGUAGE" \
                  -H "Accept-Encoding: $ACCEPT_ENCODING" \
                  -H "Connection: keep-alive" \
                  -H "Referer: https://freecloud.ltd/server/lxc" \
                  --compressed \
                  --max-time 30 "https://freecloud.ltd/server/detail/$MACHINE_ID" > /dev/null
                
                # æ‰§è¡Œç»­è´¹æ“ä½œ
                echo "æ‰§è¡Œç»­è´¹æ“ä½œ..."
                SLEEP_TIME=$(( RANDOM % 2 + 1 ))
                sleep $SLEEP_TIME
                
                RENEW_RESULT=$(curl -s -c "$COOKIE_JAR" -b "$COOKIE_JAR" \
                  -X POST \
                  -H "User-Agent: $RANDOM_UA" \
                  -H "Content-Type: application/x-www-form-urlencoded" \
                  -H "Accept: application/json, text/javascript, */*; q=0.01" \
                  -H "Accept-Language: $ACCEPT_LANGUAGE" \
                  -H "Accept-Encoding: $ACCEPT_ENCODING" \
                  -H "X-Requested-With: XMLHttpRequest" \
                  -H "Connection: keep-alive" \
                  -H "Referer: https://freecloud.ltd/server/detail/$MACHINE_ID" \
                  -H "Origin: https://freecloud.ltd" \
                  --data-urlencode "month=1" \
                  --data-urlencode "coupon_id=0" \
                  --data-urlencode "submit=1" \
                  --compressed \
                  --max-time 45 \
                  "https://freecloud.ltd/server/detail/$MACHINE_ID/renew")
                  
                echo "ç»­è´¹ç»“æœ: $RENEW_RESULT"
                
                # å‘é€Telegramé€šçŸ¥
                if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
                  if echo "$RENEW_RESULT" | grep -q "success\|æˆåŠŸ\|code\":0"; then
                    MESSAGE="âœ… åŠ å¼ºç‰ˆcurl: æœåŠ¡å™¨ $MACHINE_ID ç»­è´¹æˆåŠŸï¼åŸå‰©ä½™: $DAYS_LEFT å¤©ã€‚"
                  else
                    MESSAGE="âŒ åŠ å¼ºç‰ˆcurl: æœåŠ¡å™¨ $MACHINE_ID ç»­è´¹å¤±è´¥ã€‚åŸå‰©ä½™: $DAYS_LEFT å¤©ã€‚"
                  fi
                  
                  curl -s -X POST \
                    -H "Content-Type: application/json" \
                    --data "{\"chat_id\":\"$TELEGRAM_CHAT_ID\",\"text\":\"$MESSAGE\",\"parse_mode\":\"Markdown\"}" \
                    "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage"
                fi
              else
                echo "å‰©ä½™å¤©æ•°ä¸º $DAYS_LEFT å¤©ï¼Œæ— éœ€ç»­è´¹"
                
                # å‘é€Telegramé€šçŸ¥
                if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
                  MESSAGE="â„¹ï¸ åŠ å¼ºç‰ˆcurl: æœåŠ¡å™¨ $MACHINE_ID å‰©ä½™ $DAYS_LEFT å¤©ï¼Œæ— éœ€ç»­è´¹ã€‚"
                  
                  curl -s -X POST \
                    -H "Content-Type: application/json" \
                    --data "{\"chat_id\":\"$TELEGRAM_CHAT_ID\",\"text\":\"$MESSAGE\",\"parse_mode\":\"Markdown\"}" \
                    "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage"
                fi
              fi
            else
              echo "æœªèƒ½æ‰¾åˆ°æœåŠ¡å™¨ $MACHINE_ID çš„å‰©ä½™å¤©æ•°ä¿¡æ¯"
              
              # å‘é€Telegramé€šçŸ¥
              if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
                MESSAGE="âš ï¸ åŠ å¼ºç‰ˆcurl: æœªèƒ½æ‰¾åˆ°æœåŠ¡å™¨ $MACHINE_ID çš„ä¿¡æ¯ï¼Œæ— æ³•ç»­è´¹ã€‚"
                
                curl -s -X POST \
                  -H "Content-Type: application/json" \
                  --data "{\"chat_id\":\"$TELEGRAM_CHAT_ID\",\"text\":\"$MESSAGE\",\"parse_mode\":\"Markdown\"}" \
                  "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage"
              fi
            fi
          else
            echo "é‡è¯•ç™»å½•ä¹Ÿå¤±è´¥ï¼Œæ— æ³•è·å–æœåŠ¡å™¨ä¿¡æ¯"
            
            # å‘é€Telegramé€šçŸ¥
            if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
              MESSAGE="ğŸ”´ åŠ å¼ºç‰ˆcurl: ç™»å½•Freecloudå¤±è´¥ï¼Œæ‰€æœ‰é‡è¯•æ–¹æ³•å‡å·²ç”¨å°½ã€‚è¯·æ‰‹åŠ¨æ£€æŸ¥ç½‘ç«™çŠ¶æ€ã€‚"
              
              curl -s -X POST \
                -H "Content-Type: application/json" \
                --data "{\"chat_id\":\"$TELEGRAM_CHAT_ID\",\"text\":\"$MESSAGE\",\"parse_mode\":\"Markdown\"}" \
                "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage"
            fi
          fi
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f "$COOKIE_JAR" login_page_retry_debug.txt 
