name: Freecloudè‡ªåŠ¨ç»­è´¹

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š6ç‚¹è¿è¡Œï¼ˆUTCæ—¶é—´22ç‚¹ï¼‰
    - cron: '0 22 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  renew:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: åˆ—å‡ºå·¥ä½œç›®å½•å†…å®¹
        run: |
          echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo "åˆ—å‡ºç›®å½•å†…å®¹:"
          ls -la
      
      - name: ç¡®ä¿å¿…è¦æ–‡ä»¶å­˜åœ¨
        run: |
          if [ ! -f "requirements.txt" ]; then
            echo "åˆ›å»ºrequirements.txtæ–‡ä»¶..."
            echo "requests==2.31.0" > requirements.txt
            echo "cloudscraper==1.2.71" >> requirements.txt
            echo "requirements.txtæ–‡ä»¶å·²åˆ›å»º"
          fi
          
          # æ£€æŸ¥è„šæœ¬æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          SCRIPT_PATH=$(find . -name "freecloud_renewer.py" -type f | head -n 1)
          if [ -z "$SCRIPT_PATH" ]; then
            echo "é”™è¯¯: æ‰¾ä¸åˆ°è„šæœ¬æ–‡ä»¶ freecloud_renewer.py"
            exit 1
          else
            echo "æ‰¾åˆ°è„šæœ¬: $SCRIPT_PATH"
            
            # ä¿®å¤ä¸­æ–‡å¼•å·é—®é¢˜
            echo "æ£€æŸ¥å¹¶ä¿®å¤è„šæœ¬ä¸­çš„ä¸­æ–‡å¼•å·é—®é¢˜..."
            sed -i 's/log_message(f"æœªèƒ½åœ¨æœåŠ¡å™¨ {machine_id_to_find} é™„è¿‘æ‰¾åˆ°"å¤©å"ä¿¡æ¯")/log_message(f"æœªèƒ½åœ¨æœåŠ¡å™¨ {machine_id_to_find} é™„è¿‘æ‰¾åˆ°\\"å¤©å\\"ä¿¡æ¯")/' "$SCRIPT_PATH"
            
            # æ£€æŸ¥è„šæœ¬æ–‡ä»¶ä¸­çš„è¯­æ³•é”™è¯¯
            python -m py_compile "$SCRIPT_PATH" || {
              echo "è„šæœ¬ä¸­å­˜åœ¨è¯­æ³•é”™è¯¯ï¼Œå°è¯•ä¿®å¤..."
              # æ£€æŸ¥å¹¶ä¿®å¤ç‰¹å®šçš„è¯­æ³•é”™è¯¯
              sed -i 's/f"ğŸ†˜ è„šæœ¬æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿæ„å¤–æ€»é”™è¯¯: {e}\\n\\n```/f"ğŸ†˜ è„šæœ¬æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿæ„å¤–æ€»é”™è¯¯: {e}\\n\\n```\\n/g' "$SCRIPT_PATH"
              sed -i 's/{error_details}\\n```"/{error_details}\\n```"/g' "$SCRIPT_PATH"
              
              # é€šç”¨ä¿®å¤ï¼šå°†f-stringä¸­çš„ä¸­æ–‡å¼•å·æ›¿æ¢ä¸ºè½¬ä¹‰çš„è‹±æ–‡å¼•å·
              echo "å°è¯•ä¿®å¤æ‰€æœ‰f-stringä¸­çš„ä¸­æ–‡å¼•å·..."
              grep -n 'f".*".*"' "$SCRIPT_PATH" || true
              sed -i 's/\(f"[^"]*\)"$$$$\([^"]*\)"\([^"]*"\)/\1\\"$$$$\2\\"\3/g' "$SCRIPT_PATH"
              
              echo "å°è¯•ä¿®å¤å®Œæˆï¼Œå†æ¬¡æ£€æŸ¥è¯­æ³•..."
              python -m py_compile "$SCRIPT_PATH" || {
                echo "ä»ç„¶å­˜åœ¨è¯­æ³•é”™è¯¯ï¼Œå°è¯•æ‰‹åŠ¨æ›´æ–°è„šæœ¬ä¸­é—®é¢˜è¡Œ..."
                # å¦‚æœç¼–è¯‘ä»ç„¶å¤±è´¥ï¼Œåˆ›å»ºä¸€ä¸ªä¸´æ—¶å‰¯æœ¬è¿›è¡Œæ›´å¤šè°ƒè¯•
                cp "$SCRIPT_PATH" "${SCRIPT_PATH}.bak"
                echo "#!/usr/bin/env python3" > "$SCRIPT_PATH"
                echo "print('æ£€æµ‹åˆ°è„šæœ¬è¯­æ³•é”™è¯¯ï¼Œæ— æ³•è‡ªåŠ¨ä¿®å¤ã€‚è¯·æŸ¥çœ‹æ—¥å¿—å¹¶æ‰‹åŠ¨ä¿®å¤é—®é¢˜ã€‚')" >> "$SCRIPT_PATH"
                echo "exit(1)" >> "$SCRIPT_PATH"
                echo "ä¸¥é‡é”™è¯¯: æ— æ³•ä¿®å¤è„šæœ¬ä¸­çš„è¯­æ³•é—®é¢˜ï¼Œå·²åˆ›å»ºç®€åŒ–ç‰ˆæœ¬ä»¥é˜²æ­¢å®Œå…¨å¤±è´¥ã€‚"
                echo "è¯·æ‰‹åŠ¨æ£€æŸ¥å’Œä¿®å¤åŸå§‹è„šæœ¬: ${SCRIPT_PATH}.bak"
              }
            }
          fi
          
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          cat requirements.txt
          pip install -r requirements.txt
      
      - name: åˆ›å»ºç¯å¢ƒæ£€æŸ¥è„šæœ¬
        run: |
          echo '#!/usr/bin/env python3' > check_env.py
          echo '# -*- coding: utf-8 -*-' >> check_env.py
          echo '' >> check_env.py
          echo 'import os' >> check_env.py
          echo 'import sys' >> check_env.py
          echo 'import glob' >> check_env.py
          echo 'import platform' >> check_env.py
          echo '' >> check_env.py
          echo 'print("==== ç¯å¢ƒæ£€æŸ¥å·¥å…· ====")'  >> check_env.py
          echo 'print(f"Pythonç‰ˆæœ¬: {sys.version}")' >> check_env.py
          echo 'print(f"ç³»ç»Ÿå¹³å°: {platform.platform()}")' >> check_env.py
          echo 'print(f"å½“å‰å·¥ä½œç›®å½•: {os.getcwd()}")' >> check_env.py
          echo '' >> check_env.py
          echo 'print("\\n==== ç¯å¢ƒå˜é‡æ£€æŸ¥ ====")'  >> check_env.py
          echo 'required_vars = ["FC_USERNAME", "FC_PASSWORD", "FC_MACHINE_ID", "TELEGRAM_BOT_TOKEN", "TELEGRAM_CHAT_ID"]' >> check_env.py
          echo '' >> check_env.py
          echo 'for var in required_vars:' >> check_env.py
          echo '    value = os.getenv(var)' >> check_env.py
          echo '    if value:' >> check_env.py
          echo '        masked = value[:2] + "*" * (len(value) - 4) + value[-2:] if len(value) > 4 else "****"' >> check_env.py
          echo '        print(f"{var}: {masked} [å·²è®¾ç½®]")' >> check_env.py
          echo '    else:' >> check_env.py
          echo '        print(f"{var}: [æœªè®¾ç½®]")' >> check_env.py
          echo '' >> check_env.py
          echo 'print("\\n==== ç›®å½•å†…å®¹ ====")'  >> check_env.py
          echo 'for item in sorted(os.listdir(".")):' >> check_env.py
          echo '    if os.path.isdir(item):' >> check_env.py
          echo '        print(f"ğŸ“ {item}/")' >> check_env.py
          echo '    else:' >> check_env.py
          echo '        print(f"ğŸ“„ {item} ({os.path.getsize(item)} å­—èŠ‚)")' >> check_env.py
          echo '' >> check_env.py
          echo 'print("\\n==== æŸ¥æ‰¾è„šæœ¬æ–‡ä»¶ ====")'  >> check_env.py
          echo 'script_paths = glob.glob("**/*freecloud*py", recursive=True)' >> check_env.py
          echo 'if script_paths:' >> check_env.py
          echo '    print("æ‰¾åˆ°ä»¥ä¸‹è„šæœ¬æ–‡ä»¶:")' >> check_env.py
          echo '    for path in script_paths:' >> check_env.py
          echo '        print(f"- {path} ({os.path.getsize(path)} å­—èŠ‚)")' >> check_env.py
          echo 'else:' >> check_env.py
          echo '    print("æœªæ‰¾åˆ°ä»»ä½•åŒ¹é… *freecloud*py çš„è„šæœ¬æ–‡ä»¶")' >> check_env.py
          echo '' >> check_env.py
          echo 'print("\\n==== æ£€æŸ¥å®Œæˆ ====")'  >> check_env.py
          echo "ç¯å¢ƒæ£€æŸ¥è„šæœ¬å·²åˆ›å»º"
          cat check_env.py
          
      - name: ç¯å¢ƒæ£€æŸ¥
        env:
          FC_USERNAME: ${{ secrets.FC_USERNAME }}
          FC_PASSWORD: ${{ secrets.FC_PASSWORD }}
          FC_MACHINE_ID: ${{ secrets.FC_MACHINE_ID }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          DEBUG_MODE: 'true'
        run: python check_env.py
          
      - name: è¿è¡Œç»­è´¹è„šæœ¬
        env:
          FC_USERNAME: ${{ secrets.FC_USERNAME }}
          FC_PASSWORD: ${{ secrets.FC_PASSWORD }}
          FC_MACHINE_ID: ${{ secrets.FC_MACHINE_ID }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          DEBUG_MODE: 'true'
        run: |
          # æŸ¥æ‰¾è„šæœ¬æ–‡ä»¶
          SCRIPT_PATH=$(find . -name "freecloud_renewer.py" -type f | head -n 1)
          if [ -z "$SCRIPT_PATH" ]; then
            echo "é”™è¯¯: æ‰¾ä¸åˆ°è„šæœ¬æ–‡ä»¶ freecloud_renewer.py"
            exit 1
          else
            echo "æ‰¾åˆ°è„šæœ¬: $SCRIPT_PATH"
            python "$SCRIPT_PATH"
          fi
        
      - name: å¦‚æœå¤±è´¥åˆ™é‡è¯• (å¯èƒ½æ˜¯éªŒè¯ç é—®é¢˜)
        if: failure()
        env:
          FC_USERNAME: ${{ secrets.FC_USERNAME }}
          FC_PASSWORD: ${{ secrets.FC_PASSWORD }}
          FC_MACHINE_ID: ${{ secrets.FC_MACHINE_ID }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          DEBUG_MODE: 'true'
        run: |
          echo "é¦–æ¬¡è¿è¡Œå¤±è´¥ï¼Œç­‰å¾…30ç§’åé‡è¯•..."
          sleep 30
          # æŸ¥æ‰¾è„šæœ¬æ–‡ä»¶
          SCRIPT_PATH=$(find . -name "freecloud_renewer.py" -type f | head -n 1)
          if [ -z "$SCRIPT_PATH" ]; then
            echo "é”™è¯¯: æ‰¾ä¸åˆ°è„šæœ¬æ–‡ä»¶ freecloud_renewer.py"
            exit 1
          else
            echo "æ‰¾åˆ°è„šæœ¬: $SCRIPT_PATH"
            python "$SCRIPT_PATH"
          fi 
