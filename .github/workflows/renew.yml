name: Freecloudè‡ªåŠ¨ç»­è´¹

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š6ç‚¹è¿è¡Œï¼ˆUTCæ—¶é—´22ç‚¹ï¼‰
    - cron: '0 22 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  renew:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: åˆ—å‡ºå·¥ä½œç›®å½•å†…å®¹
        run: |
          echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo "åˆ—å‡ºç›®å½•å†…å®¹:"
          ls -la
      
      - name: ç¡®ä¿å¿…è¦æ–‡ä»¶å­˜åœ¨
        run: |
          if [ ! -f "requirements.txt" ]; then
            echo "åˆ›å»ºrequirements.txtæ–‡ä»¶..."
            echo "requests==2.31.0" > requirements.txt
            echo "cloudscraper==1.2.71" >> requirements.txt
            echo "requirements.txtæ–‡ä»¶å·²åˆ›å»º"
          fi
          
          # æ£€æŸ¥è„šæœ¬æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          SCRIPT_PATH=$(find . -name "freecloud_renewer.py" -type f | head -n 1)
          if [ -z "$SCRIPT_PATH" ]; then
            echo "é”™è¯¯: æ‰¾ä¸åˆ°è„šæœ¬æ–‡ä»¶ freecloud_renewer.py"
            exit 1
          else
            echo "æ‰¾åˆ°è„šæœ¬: $SCRIPT_PATH"
            # æ£€æŸ¥è„šæœ¬æ–‡ä»¶ä¸­çš„è¯­æ³•é”™è¯¯
            python -m py_compile "$SCRIPT_PATH" || {
              echo "è„šæœ¬ä¸­å­˜åœ¨è¯­æ³•é”™è¯¯ï¼Œå°è¯•ä¿®å¤..."
              # æ£€æŸ¥å¹¶ä¿®å¤ç‰¹å®šçš„è¯­æ³•é”™è¯¯
              sed -i 's/f"ğŸ†˜ è„šæœ¬æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿæ„å¤–æ€»é”™è¯¯: {e}\\n\\n```/f"ğŸ†˜ è„šæœ¬æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿæ„å¤–æ€»é”™è¯¯: {e}\\n\\n```\\n/g' "$SCRIPT_PATH"
              sed -i 's/{error_details}\\n```"/{error_details}\\n```"/g' "$SCRIPT_PATH"
              echo "å°è¯•ä¿®å¤å®Œæˆï¼Œå†æ¬¡æ£€æŸ¥è¯­æ³•..."
              python -m py_compile "$SCRIPT_PATH"
            }
          fi
          
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          cat requirements.txt
          pip install -r requirements.txt
      
      - name: ç¯å¢ƒæ£€æŸ¥
        env:
          FC_USERNAME: ${{ secrets.FC_USERNAME }}
          FC_PASSWORD: ${{ secrets.FC_PASSWORD }}
          FC_MACHINE_ID: ${{ secrets.FC_MACHINE_ID }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          DEBUG_MODE: 'true'
        run: |
          # åˆ›å»ºç¯å¢ƒæ£€æŸ¥è„šæœ¬ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          if [ ! -f "check_env.py" ]; then
            cat > check_env.py << 'EOL'
#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import os
import sys
import glob
import platform

print("==== ç¯å¢ƒæ£€æŸ¥å·¥å…· ====")
print(f"Pythonç‰ˆæœ¬: {sys.version}")
print(f"ç³»ç»Ÿå¹³å°: {platform.platform()}")
print(f"å½“å‰å·¥ä½œç›®å½•: {os.getcwd()}")

print("\n==== ç¯å¢ƒå˜é‡æ£€æŸ¥ ====")
required_vars = [
    "FC_USERNAME", 
    "FC_PASSWORD", 
    "FC_MACHINE_ID", 
    "TELEGRAM_BOT_TOKEN", 
    "TELEGRAM_CHAT_ID"
]

for var in required_vars:
    value = os.getenv(var)
    if value:
        masked = value[:2] + "*" * (len(value) - 4) + value[-2:] if len(value) > 4 else "****"
        print(f"{var}: {masked} [å·²è®¾ç½®]")
    else:
        print(f"{var}: [æœªè®¾ç½®]")

print("\n==== ç›®å½•å†…å®¹ ====")
for item in sorted(os.listdir(".")):
    if os.path.isdir(item):
        print(f"ğŸ“ {item}/")
    else:
        print(f"ğŸ“„ {item} ({os.path.getsize(item)} å­—èŠ‚)")

print("\n==== æŸ¥æ‰¾è„šæœ¬æ–‡ä»¶ ====")
script_paths = glob.glob("**/*freecloud*py", recursive=True)
if script_paths:
    print("æ‰¾åˆ°ä»¥ä¸‹è„šæœ¬æ–‡ä»¶:")
    for path in script_paths:
        print(f"- {path} ({os.path.getsize(path)} å­—èŠ‚)")
else:
    print("æœªæ‰¾åˆ°ä»»ä½•åŒ¹é… *freecloud*py çš„è„šæœ¬æ–‡ä»¶")

print("\n==== æ–‡ä»¶æ£€æŸ¥ ====")
files_to_check = [
    "freecloud_renewer.py",
    "requirements.txt",
    ".github/workflows/renew.yml"
]

for file_path in files_to_check:
    if os.path.exists(file_path):
        print(f"âœ… {file_path} å­˜åœ¨ ({os.path.getsize(file_path)} å­—èŠ‚)")
    else:
        print(f"âŒ {file_path} ä¸å­˜åœ¨")

print("\n==== æ£€æŸ¥å®Œæˆ ====")
EOL
            echo "ç¯å¢ƒæ£€æŸ¥è„šæœ¬å·²åˆ›å»º"
          fi
          
          python check_env.py
          
      - name: è¿è¡Œç»­è´¹è„šæœ¬
        env:
          FC_USERNAME: ${{ secrets.FC_USERNAME }}
          FC_PASSWORD: ${{ secrets.FC_PASSWORD }}
          FC_MACHINE_ID: ${{ secrets.FC_MACHINE_ID }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          DEBUG_MODE: 'true'
        run: |
          # æŸ¥æ‰¾è„šæœ¬æ–‡ä»¶
          SCRIPT_PATH=$(find . -name "freecloud_renewer.py" -type f | head -n 1)
          if [ -z "$SCRIPT_PATH" ]; then
            echo "é”™è¯¯: æ‰¾ä¸åˆ°è„šæœ¬æ–‡ä»¶ freecloud_renewer.py"
            exit 1
          else
            echo "æ‰¾åˆ°è„šæœ¬: $SCRIPT_PATH"
            python "$SCRIPT_PATH"
          fi
        
      - name: å¦‚æœå¤±è´¥åˆ™é‡è¯• (å¯èƒ½æ˜¯éªŒè¯ç é—®é¢˜)
        if: failure()
        env:
          FC_USERNAME: ${{ secrets.FC_USERNAME }}
          FC_PASSWORD: ${{ secrets.FC_PASSWORD }}
          FC_MACHINE_ID: ${{ secrets.FC_MACHINE_ID }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          DEBUG_MODE: 'true'
        run: |
          echo "é¦–æ¬¡è¿è¡Œå¤±è´¥ï¼Œç­‰å¾…30ç§’åé‡è¯•..."
          sleep 30
          # æŸ¥æ‰¾è„šæœ¬æ–‡ä»¶
          SCRIPT_PATH=$(find . -name "freecloud_renewer.py" -type f | head -n 1)
          if [ -z "$SCRIPT_PATH" ]; then
            echo "é”™è¯¯: æ‰¾ä¸åˆ°è„šæœ¬æ–‡ä»¶ freecloud_renewer.py"
            exit 1
          else
            echo "æ‰¾åˆ°è„šæœ¬: $SCRIPT_PATH"
            python "$SCRIPT_PATH"
          fi 
